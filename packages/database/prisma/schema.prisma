// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model - stores authenticated user data
model User {
  id        String   @id @default(uuid())
  cognitoId String   @unique
  email     String   @unique
  name      String?
  plan      Plan     @default(FREE)
  
  // Relations
  resumes   Resume[]
  documents Document[]
  sessions  UserSession[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([cognitoId])
}

// UserSession model - tracks device sessions for multi-device support
model UserSession {
  id           String   @id @default(uuid())
  userId       String
  deviceId     String   @unique
  deviceName   String?  // e.g., "Chrome on Windows"
  deviceType   String?  // web, mobile, tablet
  ipAddress    String?
  userAgent    String?
  refreshToken String   @unique
  lastActive   DateTime @default(now())
  expiresAt    DateTime
  isActive     Boolean  @default(true)
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([refreshToken])
  @@index([lastActive])
}

enum Plan {
  FREE
  PRO
}

// Resume model - main resume entity
model Resume {
  id         String  @id @default(uuid())
  userId     String
  title      String  @default("Untitled Resume")
  templateId String? // Reference to the template used
  
  // Relations
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  template  ResumeTemplate?  @relation(fields: [templateId], references: [id], onDelete: SetNull)
  snapshots ResumeSnapshot[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([updatedAt])
  @@index([templateId])
}

// ResumeTemplate - predefined templates for resume creation
model ResumeTemplate {
  id          String  @id @default(uuid())
  slug        String  @unique // e.g., "it-developer-modern"
  name        String  @unique // e.g., "Modern Professional"
  description String? // Brief description of the template
  category    String  // "professional", "creative", "minimal"
  
  // Template structure (JSON)
  structure Json // Defines sections, order, visibility, layout
  
  // Styling information (JSON)
  theme Json // Colors, fonts, spacing, etc.
  
  // Preview image (S3 URL for future use)
  previewUrl String? // URL to template preview image
  
  // Metadata
  isActive  Boolean @default(true)
  isPremium Boolean @default(false)
  sortOrder Int     @default(0)
  
  // Relations
  resumes Resume[] // Resumes created using this template
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([category, isActive])
  @@index([sortOrder])
}

// ResumeSnapshot - version history for resumes
model ResumeSnapshot {
  id       String @id @default(uuid())
  resumeId String
  version  Int    @default(1)
  content  Json   // Full JSON Resume data
  
  // Relations
  resume Resume @relation(fields: [resumeId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())

  @@unique([resumeId, version])
  @@index([resumeId])
}

// Document - reference documents uploaded by users for AI context
model Document {
  id       String @id @default(uuid())
  userId   String
  key      String // S3 key
  fileName String
  fileType String
  size     Int    // In bytes
  
  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())

  @@index([userId])
}
